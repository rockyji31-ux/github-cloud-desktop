name: "Browser RDP v59 (Protocol Mismatch Fix)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  browser-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ğŸ”” Notify Start
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage -d chat_id=$TG_ID -d text="ğŸŒ <b>Starting Browser RDP...</b>%0APlease wait 3 mins." -d parse_mode="HTML"

      # 1. Install Desktop Environment
      - name: ğŸ’» Install Desktop
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies tigervnc-standalone-server python3-numpy dbus-x11
          sudo apt-get clean
          echo "âœ… Desktop Installed"

      # 2. Setup VNC (Stable Xstartup)
      - name: ğŸ” Setup VNC
        run: |
          mkdir -p ~/.vnc
          echo "123456" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # ğŸ›‘ FIXED: Added dbus-launch to keep session alive
          cat <<EOF > ~/.vnc/xstartup
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &
          EOF
          
          chmod +x ~/.vnc/xstartup
          
          # Start VNC Server
          vncserver :1 -geometry 1280x720 -depth 24
          echo "âœ… VNC Server Started"

      # 3. Setup noVNC (HTTP Mode - Fixes 502 Error)
      - name: ğŸŒ Setup noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          
          # ğŸ›‘ FIXED: Removed SSL generation & --ssl-only flag
          # Now it listens on plain HTTP, which Cloudflare loves.
          ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
          
          # Wait for port to open
          sleep 5
          echo "âœ… noVNC Web Server Started on Port 6080"

      # 4. Cloudflare Tunnel
      - name: ğŸš€ Cloudflare Tunnel & Telegram
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          
          # Start Tunnel pointing to HTTP port 6080
          nohup cloudflared tunnel --url http://localhost:6080 --no-autoupdate > tunnel.log 2>&1 &
          
          echo "â³ Waiting for URL..."
          sleep 10
          URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$URL" ]; then URL="Error: Check GitHub Logs"; fi
          
          echo "ğŸ”— Web URL: $URL"
          
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
          -d chat_id=$TG_ID \
          -d text="âœ… <b>Browser RDP Ready!</b>%0A%0AğŸ”— <b>Link:</b> $URL%0AğŸ”‘ <b>Password:</b> <code>123456</code>%0A%0A<i>Click link -> Connect -> Enter Password</i>" \
          -d parse_mode="HTML"

      # 5. Keep Alive Loop
      - name: ğŸ”„ Keep Alive & Auto-Trigger
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          START=$(date +%s)
          while true; do
            NOW=$(date +%s)
            DIFF=$((NOW - START))
            if [ $DIFF -ge 21000 ]; then
               echo "ğŸ”« Triggering Next RDP..."
               gh workflow run main.yml
               sleep 300
               exit 0
            fi
            sleep 60
          done
