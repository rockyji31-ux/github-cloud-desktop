name: "Browser RDP v63 (Chrome Edition)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

# ğŸ›‘ HIGHLANDER RULE: Only 1 active instance
concurrency:
  group: "browser-rdp-session"
  cancel-in-progress: true

jobs:
  browser-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours Max

    steps:
      - name: ğŸ”” Notify Start
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage -d chat_id=$TG_ID -d text="ğŸŒ <b>Starting RDP v63 (Chrome Mode)...</b>%0APlease wait 3 mins." -d parse_mode="HTML"

      # 1. OPTIMIZATION
      - name: âš¡ Tune System
        run: |
          # 4GB Swap for Chrome Tabs
          sudo fallocate -l 4G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          sudo sysctl -w net.core.default_qdisc=fq && sudo sysctl -w net.ipv4.tcp_congestion_control=bbr
          
          # ğŸ‡®ğŸ‡³ Timezone: Kolkata
          sudo timedatectl set-timezone Asia/Kolkata
          echo "âœ… System Tuned (IST)"

      # 2. INSTALL DESKTOP & CHROME
      - name: ğŸ’» Install Desktop & Chrome
        run: |
          sudo apt-get update
          
          # Install Desktop Environment
          sudo apt-get install -y xfce4 xfce4-goodies tigervnc-standalone-server python3-numpy dbus-x11 xorg x11-xserver-utils pulseaudio pavucontrol
          
          # Install Themes & Utilities
          sudo apt-get install -y arc-theme papirus-icon-theme autocutsel
          
          # ğŸ—‘ï¸ Remove Firefox (Just in case)
          sudo apt-get remove -y firefox || true
          
          # ğŸŒ Install Google Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
          
          sudo apt-get clean
          echo "âœ… Chrome & Desktop Installed"

      # 3. SETUP VNC & DARK MODE
      - name: ğŸ” Setup VNC
        run: |
          mkdir -p ~/.vnc
          echo "123456" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          cat <<EOF > ~/.vnc/xstartup
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          
          # Start Clipboard Sync
          autocutsel -fork
          
          # Force Dark Theme (Arc-Dark)
          (
            sleep 5
            xfconf-query -c xsettings -p /Net/ThemeName -s 'Arc-Dark' --create -t string
            xfconf-query -c xfwm4 -p /general/theme -s 'Arc-Dark' --create -t string
            xfconf-query -c xsettings -p /Net/IconThemeName -s 'Papirus-Dark' --create -t string
          ) &
          
          # Start Desktop (Zombie Mode - Never Crash)
          dbus-launch --exit-with-session xfce4-session &
          sleep 2
          tail -f /dev/null
          EOF
          
          chmod +x ~/.vnc/xstartup
          vncserver :1 -geometry 1280x720 -depth 24
          echo "âœ… VNC Started"

      # 4. SETUP noVNC
      - name: ğŸŒ Setup noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          ln -s vnc.html noVNC/index.html
          ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
          sleep 5

      # 5. CLOUDFLARE TUNNEL
      - name: ğŸš€ Cloudflare Tunnel & Notify
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          
          nohup cloudflared tunnel --url http://localhost:6080 --no-autoupdate > tunnel.log 2>&1 &
          
          echo "â³ Waiting for URL..."
          sleep 10
          URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          if [ -z "$URL" ]; then URL="Error: Check Logs"; fi
          
          echo "ğŸ”— URL: $URL"
          
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
          -d chat_id=$TG_ID \
          -d text="âœ… <b>RDP v63 Ready!</b>%0A%0AğŸ”— <b>Link:</b> $URL%0AğŸ”‘ <b>Pass:</b> <code>123456</code>%0AğŸŒ <b>Browser:</b> Google Chrome%0AğŸŒ‘ <b>Theme:</b> Dark Mode" \
          -d parse_mode="HTML"

      # 6. HIGHLANDER LOOP (5h 57m)
      - name: ğŸ”„ Highlander Logic
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          START=$(date +%s)
          # 21420 seconds = 5h 57m
          while true; do
            NOW=$(date +%s)
            DIFF=$((NOW - START))
            if [ $DIFF -ge 21420 ]; then
               echo "ğŸ”« Triggering Next Runner..."
               gh workflow run main.yml
               echo "ğŸ’€ Dying..."
               sleep 60
               exit 0
            fi
            sleep 60
          done
